---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: crowdsec-system
spec:
  interval: 10m0s
  chart:
    spec:
      chart: crowdsec
      version: ">=0.9.12 <0.10.0"
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: crowdsec-system
      interval: 1m
  values:
    container_runtime: containerd
    tls:
      enabled: true
      bouncer:
        reflector:
          namespaces:
            - traefik-system
    lapi:
      # replicas: 2
      ingress:
        enabled: true
        annotations:
          cert-manager.io/cluster-issuer: local
        host: lapi.crowdsec.omnilium.local
        tls:
          - secretName: crowdsec-lapi-ingress-tls
            hosts:
              - lapi.crowdsec.omnilium.local
      # priorityClassName: critical
      # podLabels:
      #   app.omnilium.local/identifier: crowdsec-lapi
      dashboard:
        enabled: true
        resources: {}
        ingress:
          enabled: true
          annotations:
            cert-manager.io/cluster-issuer: local
          host: crowdsec.omnilium.local
          tls:
            - secretName: crowdsec-dashboard-tls
              hosts:
                - crowdsec.omnilium.local
      resources:
        limits:
          memory: 100Mi
        requests:
          cpu: 150m
          memory: 100Mi
      persistentVolume:
        data:
          storageClassName: replicated
          size: 2Gi
        config:
          storageClassName: replicated
          size: 500Mi
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         podAffinityTerm:
      #           labelSelector:
      #             matchLabels:
      #               app.omnilium.local/identifier: crowdsec-lapi
      #           topologyKey: topology.omnilium.local/host
      # topologySpreadConstraints:
      #   - labelSelector:
      #       matchLabels:
      #         app.omnilium.local/identifier: crowdsec-lapi
      #     topologyKey: topology.kubernetes.io/zone
      #     maxSkew: 1
      #     whenUnsatisfiable: ScheduleAnyway
      strategy:
        type: Recreate
    agent:
      acquisition:
        - namespace: traefik-system
          podName: traefik-*
          program: traefik
      # priorityClassName: high
      # podLabels:
      #   app.omnilium.local/identifier: crowdsec-agent
      persistentVolume:
        config:
          enabled: false
      env:
        - name: PARSERS
          value: "crowdsecurity/cri-logs"
        - name: COLLECTIONS
          value: "crowdsecurity/traefik"
