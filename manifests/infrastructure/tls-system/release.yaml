---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tls
  namespace: tls-system
spec:
  interval: 10m0s
  chart:
    spec:
      chart: cert-manager
      version: ">=1.14.4 <1.15.0"
      sourceRef:
        kind: HelmRepository
        name: tls
        namespace: tls-system
      interval: 1m
  values:
    global:
      priorityClassName: medium
    installCRDs: true
    replicaCount: 2
    podDisruptionBudget:
      enabled: true
      minAvailable: 1
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 100m
        memory: 200Mi
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: cert-manager
                  app.kubernetes.io/instance: tls
              topologyKey: topology.omnilium.local/host
    topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            app.kubernetes.io/name: cert-manager
            app.kubernetes.io/instance: tls
        topologyKey: topology.kubernetes.io/zone
        maxSkew: 1
        whenUnsatisfiable: ScheduleAnyway
    webhook:
      replicaCount: 2
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      resources:
        requests:
          cpu: 50m
          memory: 100Mi
        limits:
          cpu: 100m
          memory: 200Mi
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: webhook
                    app.kubernetes.io/instance: tls
                topologyKey: topology.omnilium.local/host
        topologySpreadConstraints:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: webhook
                app.kubernetes.io/instance: tls
            topologyKey: topology.kubernetes.io/zone
            maxSkew: 1
            whenUnsatisfiable: ScheduleAnyway
    cainjector:
      replicaCount: 2
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      resources:
        requests:
          cpu: 50m
          memory: 100Mi
        limits:
          cpu: 100m
          memory: 200Mi
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: cainjector
                    app.kubernetes.io/instance: tls
                topologyKey: topology.omnilium.local/host
        topologySpreadConstraints:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: cainjector
                app.kubernetes.io/instance: tls
            topologyKey: topology.kubernetes.io/zone
            maxSkew: 1
            whenUnsatisfiable: ScheduleAnyway
