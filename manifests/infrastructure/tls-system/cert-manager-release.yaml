---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cert-manager
  namespace: tls-system
spec:
  interval: 10m0s
  chart:
    spec:
      chart: cert-manager
      version: ">=1.14.4 <1.15.0"
      sourceRef:
        kind: HelmRepository
        name: tls
        namespace: tls-system
      interval: 1m
  values:
    global:
      priorityClassName: medium
    installCRDs: true
    # The below doesn't work for some reason
    # crds:
    #   enabled: true
    replicaCount: 2
    podDisruptionBudget:
      enabled: true
      minAvailable: 1
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 100m
        memory: 200Mi
    podLabels:
      app.omnilium.local/identifier: cert-manager
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.omnilium.local/identifier: cert-manager
              topologyKey: topology.omnilium.local/host
    topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            app.omnilium.local/identifier: cert-manager
        topologyKey: topology.kubernetes.io/zone
        maxSkew: 1
        whenUnsatisfiable: ScheduleAnyway
    webhook:
      replicaCount: 2
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      resources:
        requests:
          cpu: 50m
          memory: 100Mi
        limits:
          cpu: 100m
          memory: 200Mi
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.omnilium.local/identifier: cert-manager-webhook
                topologyKey: topology.omnilium.local/host
      topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              app.omnilium.local/identifier: cert-manager-webhook
          topologyKey: topology.kubernetes.io/zone
          maxSkew: 1
          whenUnsatisfiable: ScheduleAnyway
      podLabels:
        app.omnilium.local/identifier: cert-manager-webhook
    cainjector:
      replicaCount: 2
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      resources:
        requests:
          cpu: 50m
          memory: 100Mi
        limits:
          cpu: 100m
          memory: 200Mi
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.omnilium.local/identifier: cert-manager-cainjector
                topologyKey: topology.omnilium.local/host
      topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              app.omnilium.local/identifier: cert-manager-cainjector
          topologyKey: topology.kubernetes.io/zone
          maxSkew: 1
          whenUnsatisfiable: ScheduleAnyway
      podLabels:
        app.omnilium.local/identifier: cert-manager-cainjector
