---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mayastor
  namespace: mayastor-system
spec:
  interval: 10m0s
  chart:
    spec:
      chart: mayastor
      version: ">=2.5.0 <2.6.0"
      sourceRef:
        kind: HelmRepository
        name: mayastor
        namespace: mayastor-system
      interval: 1m
  values:
    # https://github.com/siderolabs/talos/issues/8001#issuecomment-1859079349
    crds:
      jaeger:
        enabled: false
    priorityClassName: critical
    base:
      metrics:
        enabled: false
    operators:
      pool:
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 100m
            memory: 100Mi
    agents:
      core:
        resources:
          requests:
            cpu: "1"
            memory: 100Mi
          limits:
            cpu: "1"
            memory: 100Mi
        priorityClassName: mayastor-cluster-critical
      ha:
        node:
          resources:
            requests:
              cpu: 100m
              memory: 100Mi
            limits:
              cpu: 100m
              memory: 100Mi
        cluster:
          resources:
            requests:
              cpu: 100m
              memory: 100Mi
            limits:
              cpu: 100m
              memory: 100Mi
    apis:
      rest:
        replicaCount: 2
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 100m
            memory: 100Mi
    csi:
      controller:
        resources:
          requests:
            cpu: 100m
            memory: 250Mi
          limits:
            cpu: 100m
            memory: 250Mi
      node:
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 100m
            memory: 100Mi
        nvme:
          ctrl_loss_tmo: "300"
    io_engine:
      nvme:
        ioTimeout: 60s
      priorityClassName: critical
    etcd:
      resources:
        requests:
          cpu: 100m
          memory: 150Mi
        limits:
          cpu: 100m
          memory: 150Mi
      localpvScConfig:
        basePath: "/var/openebs/local/{{ .Release.Name }}/etcd"
      priorityClassName: critical
    loki-stack:
      enabled: false
      localpvScConfig:
        basePath: "/var/openebs/local/{{ .Release.Name }}/loki"
    nats:
      nats:
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 100m
            memory: 100Mi
        jetstream:
          memStorage:
            size: 10Mi
      priorityClassName: critical
    obs:
      callhome:
        resources:
          requests:
            cpu: 100m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 50Mi
        priorityClassName: low-no-preempting
      stats:
        resources:
          requests:
            cpu: 100m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 50Mi
    storageClass:
      enabled: false
