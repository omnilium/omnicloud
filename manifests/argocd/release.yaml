apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
    name: argocd
    namespace: flux-system
spec:
    interval: 10m0s
    timeout: 5m0s
    chart:
        spec:
            chart: argo-cd
            version: 6.7.*
            sourceRef:
                kind: HelmRepository
                name: argocd
            interval: 60m0s
    releaseName: argocd
    targetNamespace: argocd
    install:
        remediation:
            retries: 3
        createNamespace: true
    upgrade:
        remediation:
            retries: 3
    values:
        crds:
            keep: false
        global:
            domain: argocd.omnilium.local
        configs:
            cm:
                dex.config: |
                    connectors:
                      - type: oidc
                        id: forgejo
                        name: Forgejo
                        config:
                          issuer: https://git.omni.ms/
                          clientID: 1e3265ca-f7cd-474f-84cc-fdd1250ba5cc
                          clientSecret: $dex.forgejo.clientSecret
                          insecureEnableGroups: true
                          scopes:
                            - profile
                            - email
                            - groups
            params:
                server.insecure: true
            rbac:
                policy.default: role:readonly
                policy.csv: |
                    g, omnilium:owners, role:admin

                    p, role:workshop, applications, get, workshop/*, allow
                    p, role:workshop, projects, get, workshop, allow
                    p, role:workshop, logs, get, workshop/*, allow
                    g, omnilium:workshop, role:workshop
            secret:
                extra:
                    dex.forgejo.clientSecret: ENC[AES256_GCM,data:mB//W2J8ecOsBy/g75/7icbUF8nnKP+j35NXA005nF/Fi5SlnJCKQYVo3A4c//n2TTbIFGv9W9w=,iv:xc0BNYPNfvUro6nvn3Cxkp6GtQEPapNZoYRCUWJ5RR8=,tag:dRiJb/4AE5L4R2zoLDiLkw==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-15T09:52:46Z"
    mac: ENC[AES256_GCM,data:r1ZgHlkqA7FNkv35vVPOl/DVgUj+owxaNa8r8i8xVGeSbYCCbXkJFcue4wVtqxhYU8Dp589R9vdCSQCM9lwEPqkjV4QZjpHP6qHLOUjdhLaeJziPvBd6KSgULEszFiCXaLnzLN7vUGSqzvXz/4mZrdlovnUj+j4TIMXovgvq92g=,iv:qBS6n9pifKE7qvQdbgieMz/VdhavuidMABuPxpQzfyw=,tag:GduOoCZyw7Fg5EQLnxYJGA==,type:str]
    pgp:
        - created_at: "2024-04-15T09:52:46Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMEMw3pELiPsnbbIbaIMUVtR+p4XUXYo/BFb+LVAfmW+pfn
            ZjAFCbxxVykm4SrDAHnKmK3ddkN0lxUK1qkTOo+5sKZ44f98W3cBQFW36xoMaSW7
            NqykgOxVQ6WE6N8UOHMDMAFC+MtefjN8JIA5Ar7Jpx+CDxl/WaQYMb99L2t2vdH5
            Mmz3vQDn37U1DfEA7E17CtRoAQkCEJvesIbyQhwVladxDi3qjI72WS9EGINDMPD+
            G8KlOmsL+4dm3MNTs4BYpLb9LkJBo9moy7jZcO/TTOkJ9d1tZLLxqDBwiOrRyb64
            pW9qr1cjbjjMGKefBZpH+ow3KbKq30mF55k=
            =TcKT
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-15T09:52:46Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwMEd3zQpd7mT7agqXL1FtQZXr7PXUz2HX572jX1ovcs/weR
            FgA7CeHdnOKpKG46e7ojYo/m/bqkiAWlvlwMtzdw2BHGj720cOVSWqQCnD50B08T
            8eCkp3IhWYJjY5LyTP5eMK1zkKcoZKF6cTveBIztHlA1DyjF6AmNPhiWTxilhyc9
            O92Qvj4YtHTzUtDNEHAcg9RoAQkCEJWuYIyAbCmiz1ejJus4CU05FraUxws90GW0
            E+X3vNMzdQF8RqbaZrKKPoLg2CNtWXWu9ejGV62QfVzU9c2l77D5h0veTWdnxfHN
            RHdxyCcSpVFL04nFtiyrcqfef3dyIrgXVAM=
            =aUMq
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(data|stringData|password|secret|secretKey)$
    version: 3.8.1
