apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab
spec:
  interval: 10m0s
  chart:
    spec:
      chart: gitlab
      version: ">=7.10.1 <7.11.0"
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: gitlab
      interval: 1m
  values:
    global:
      pod:
        labels:
          app.omnilium.local/identifier: gitlab
      hosts:
        https: true
        gitlab:
          name: git.omni.ms
        registry:
          name: registry.omni.ms
        smartcard:
          name: git.omni.ms
        kas:
          name: kas.omni.ms
        pages:
          name: pages.omni.ms
        ssh: git.omni.ms
      ingress:
        configureCertmanager: false
        class: traefik
        provider: traefik
        annotations:
          cert-manager.io/cluster-issuer: acme
        tls:
          enabled: true
      psql:
        password:
          useSecret: true
          secret: gitlab
          key: postgres_password
        host: postgres-postgresql-ha-pgpool.gitlab.svc.cluster.local
        port: 5432
        username: gitlab
        database: gitlab
        preparedStatements: true
        keepalives: 0
      redis:
        auth:
          enabled: true
          secret: gitlab
          key: redis_password
        host: gitlab
        port: 6379
        sentinels:
          - host: redis.gitlab.svc.cluster.local
            port: 26379
      minio:
        enabled: false
      appConfig:
        contentSecurityPolicy:
          enabled: true
          report_only: false
        object_store:
          enabled: true
          proxy_download: true
          connection:
            secret: gitlab
            key: object_store_connection
        lfs:
          enabled: true
          proxy_download: true
          bucket: git-lfs
        artifacts:
          enabled: true
          proxy_download: true
          bucket: gitlab-artifacts
        uploads:
          enabled: true
          proxy_download: true
          bucket: gitlab-uploads
        packages:
          enabled: true
          proxy_download: true
          bucket: gitlab-packages
        externalDiffs:
          enabled: true
          proxy_download: true
          bucket: gitlab-mr-diffs
        terraformState:
          enabled: true
          bucket: gitlab-terraform-state
        ciSecureFiles:
          enabled: true
          bucket: gitlab-ci-secure-files
          connection:
            secret: gitlab
            key: object_store_connection
        dependencyProxy:
          enabled: true
          proxy_download: true
          bucket: gitlab-dependency-proxy
      spamcheck:
        enabled: true
      pages:
        enabled: true
        accessControl: true
        host: pages.omni.ms
        externalHttp:
          - 10.0.1.1
        externalHttps:
          - 10.0.1.1
      smtp:
        enabled: true
        address: smtp.eu.mailgun.org
        port: 587
        user_name: gitlab@mg.omni.ms
        password:
          secret: gitlab
          key: mailgun_password
        starttls_auto: true
      email:
        from: git@omni.ms
      affinity:
        podAntiAffinity:
          topologyKey: topology.omnilium.local/host
    certmanager:
      installCRDs: false
      install: false
      rbac:
        create: false
    nginx-ingress:
      enabled: false
    prometheus:
      install: false
    redis:
      install: false
    postgresql:
      install: false
    gitlab:
      gitaly:
        priorityClassName: high
        persistence:
          storageClass: replicated
        resources:
          # limits:
          #  cpu: 100m
          #  memory: 128Mi
          requests:
            cpu: 100m
            memory: 200Mi
        gpgSigning:
          enabled: true
          secret: gitlab
          key: gpg_private_key
      gitlab-exporter:
        resources:
          # limits:
          #  cpu: 1
          #  memory: 2G
          requests:
            cpu: 75m
            memory: 100M
      gitlab-pages:
        hpa:
          maxReplicas: 3
          minReplicas: 1
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        maxUnavailable: 1
        resources:
          # limits:
          #   cpu: 900m
          #   memory: 2G
          requests:
            cpu: 900m
            memory: 2G
        priorityClassName: low
        redirectHttp: true
      gitlab-shell:
        service:
          type: LoadBalancer
        priorityClassName: medium
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 50m
            memory: 50Mi
        maxUnavailable: 1
        minReplicas: 2
        maxReplicas: 5
        hpa:
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
      kas:
        hpa:
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        ingress:
          tls:
            secretName: gitlab-kas-tls
        maxReplicas: 3
        maxUnavailable: 1
        minReplicas: 1
        resources:
          # limits:
          #   cpu: 100m
          #   memory: 100M
          requests:
            cpu: 100m
            memory: 100M
      mailroom:
        hpa:
          maxReplicas: 3
          minReplicas: 1
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        resources:
          # limits:
          #  cpu: 1
          #  memory: 2G
          requests:
            cpu: 50m
            memory: 150M
      migrations:
        priorityClassName: high
        resources:
          limits:
            cpu: 250m
            memory: 200Mi
          requests:
            cpu: 250m
            memory: 200Mi
      sidekiq:
        minReplicas: 2
        maxReplicas: 5
        hpa:
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        resources:
          # limits:
          #  memory: 5G
          requests:
            cpu: 900m
            memory: 2G
        maxUnavailable: 1
        priorityClassName: medium
      spamcheck:
        hpa:
          maxReplicas: 5
          minReplicas: 2
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        maxUnavailable: 1
        priorityClassName: high
        resources:
          # limits:
          #   cpu: 100m
          #   memory: 100M
          requests:
            cpu: 100m
            memory: 100M
      toolbox:
        priorityClassName: medium
        backups:
          cron:
            enabled: true
            extraArgs: "--maximum-backups 14"
          objectStorage:
            config:
              secret: gitlab
              key: backups_connection
        resources:
          # limits:
          #  cpu: 1
          #  memory: 2G
          requests:
            cpu: 50m
            memory: 350M
      webservice:
        ingress:
          tls:
            secretName: gitlab-tls
        hpa:
          cpu:
            targetType: Utilization
            targetAverageUtilization: 75
          memory:
            targetType: Utilization
            targetAverageUtilization: 75
          behavior:
            scaleDown:
              stabilizationWindowSeconds: 300
        workhorse:
          resources:
            # limits:
            #   cpu: 100m
            #   memory: 100M
            requests:
              cpu: 100m
              memory: 100M
        trusted_proxies:
          - 10.0.0.0/8
        resources:
          # limits:
          #  cpu: 1.5
          #  memory: 3G
          requests:
            cpu: 300m
            memory: 2.5G
        maxUnavailable: 1
        minReplicas: 2
        maxReplicas: 5
        priorityClassName: high
    registry:
      priorityClassName: low
      ingress:
        tls:
          secretName: gitlab-registry-tls
      resources:
        # limits:
        #   cpu: 200m
        #   memory: 1024Mi
        requests:
          cpu: 50m
          memory: 32Mi
      maxUnavailable: 1
      hpa:
        maxReplicas: 5
        minReplicas: 2
        cpu:
          targetType: Utilization
          targetAverageUtilization: 75
        memory:
          targetType: Utilization
          targetAverageUtilization: 75
        behavior:
          scaleDown:
            stabilizationWindowSeconds: 300
    gitlab-zoekt:
      install: true
      indexStorage: 20Gi
      replicas: 1
      indexer:
        resources:
          # limits:
          #   cpu: 200m
          #   memory: 1024Mi
          # requests:
          #   cpu: 50m
          #   memory: 32Mi
      webserver:
        resources:
          # limits:
          #   cpu: 200m
          #   memory: 1024Mi
          # requests:
          #   cpu: 50m
          #   memory: 32Mi
      gateway:
        resources:
          # limits:
          #   cpu: 200m
          #   memory: 1024Mi
          # requests:
          #   cpu: 50m
          #   memory: 32Mi
      resources:
        # limits:
        #   cpu: 100m
        #   memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi
