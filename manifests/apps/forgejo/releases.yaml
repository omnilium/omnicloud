apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: forgejo
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: forgejo
            version: ">=5.0.3 <5.1.0"
            sourceRef:
                kind: HelmRepository
                name: forgejo
                namespace: forgejo
            interval: 1m
    values:
        strategy:
            type: Recreate
        service:
            ssh:
                type: LoadBalancer
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: acme
            hosts:
                - host: git.omni.ms
                  paths:
                      - path: /
                        pathType: Prefix
            tls:
                - secretName: forgejo-tls
                  hosts:
                      - git.omni.ms
        resources:
            requests:
                cpu: 50m
                memory: 150Mi
            limits:
                cpu: 250m
                memory: 500Mi
        persistence:
            size: 25Gi
            storageClass: replicated
            annotations:
                helm.sh/resource-policy: keep
        signing:
            enabled: true
            existingSecret: forgejo-signing
        gitea:
            admin:
                username: webmaster
                password: aMLwKD1teiNtv9U4I6IsKEqAqyQSawIob2RGSxQIMcw
                email: webmaster@omnilium.com
            config:
                repository:
                    ACCESS_CONTROL_ALLOW_ORIGIN: git.omni.ms
                    DEFAULT_REPO_UNITS: repo.code,repo.releases,repo.pulls
                repository.pull-request:
                    DEFAULT_MERGE_STYLE: rebase-merge
                repository.upload:
                    FILE_MAX_SIZE: 10
                cors:
                    ENABLED: true
                    SCHEME: https
                    ALLOW_DOMAIN: git.omni.ms
                ui:
                    DEFAULT_SHOW_FULL_NAME: true
                ui.meta:
                    AUTHOR: Omnicloud Forgejo
                    KEYWORDS: git,forge,forgejo,omnicloud,omnilium
                server:
                    ENABLE_GZIP: true
                    LFS_START_SERVER: true
                indexer:
                    ISSUE_INDEXER_TYPE: elasticsearch
                    ISSUE_INDEXER_CONN_STR: <http://elastic:Kk9r2D5ZvL1237i9JXfgb4E1@forgejo-es-http.forgejo.svc.cluster.local:9200>
                    REPO_INDEXER_ENABLED: true
                    REPO_INDEXER_TYPE: elasticsearch
                    REPO_INDEXER_CONN_STR: <http://elastic:Kk9r2D5ZvL1237i9JXfgb4E1@forgejo-es-http.forgejo.svc.cluster.local:9200>
                security:
                    REVERSE_PROXY_TRUSTED_PROXIES: 10.0.0.0/8
                    PASSWORD_HASH_ALGO: argon2
                    PASSWORD_COMPLEXITY: lower,upper,digit
                service:
                    DISABLE_REGISTRATION: true
                    DEFAULT_ENABLE_TIMETRACKING: false
                    DEFAULT_ORG_MEMBER_VISIBLE: true
                    VALID_SITE_URL_SCHEMES: https
                picture:
                    AVATAR_MAX_FILE_SIZE: 5242880
                    AVATAR_MAX_ORIGIN_SIZE: 524288
                    REPOSITORY_AVATAR_FALLBACK: image
                    # AVATAR_STORAGE_TYPE: minio
                    # REPOSITORY_AVATAR_STORAGE_TYPE: minio
                attachment:
                    MAX_SIZE: 10
                    # STORAGE_TYPE: minio
                cron:
                    ENABLED: true
                time:
                    DEFAULT_UI_LOCATION: Europe/Bucharest
                # packages:
                #     STORAGE_TYPE: minio
                mirror:
                    MIN_INTERVAL: 30m
                # lfs:
                #     STORAGE_TYPE: minio
                # repo-avatar:
                #     STORAGE_TYPE: minio
                # repo-archive:
                #     STORAGE_TYPE: minio
                # avatar:
                #     STORAGE_TYPE: minio
                # storage.actions_log:
                #     STORAGE_TYPE: minio
                # storage.artifacts:
                #     STORAGE_TYPE: minio
                # storage:
                #     MINIO_ENDPOINT: <minio.forgejo.svc.cluster.local>
                #     MINIO_ACCESS_KEY_ID: forgejo
                #     MINIO_SECRET_ACCESS_KEY: p3DiX4Xb76qSxDW3bwXkTRhSrMgFXA9w
                #     MINIO_BUCKET: forgejo
                #     MINIO_LOCATION: hel1
                #     MINIO_USE_SSL: false
        postgresql-ha:
            global:
                postgresql:
                    database: forgejo
                    password: 2wXenH1oNHWOIL8tNgO9nHKG1ScwGICSOn3p4CTksc4
                    username: forgejo
            postgresql:
                repmgrPassword: OFmiE4fAqmQsx1u8fgWqa56QpAScohbk1OSXZZeykIo
                postgresPassword: LYfivLxxpdKigbYXQFiEPYiYylBNEQLKLoulCAYZxk8
                password: 2wXenH1oNHWOIL8tNgO9nHKG1ScwGICSOn3p4CTksc4
            pgpool:
                adminPassword: od42nikcjhshWMhCBX2LoTbr69svk9BpYkSFGwgH6zo
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: minio
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: tenant
            version: ">=5.0.14 <5.1.0"
            sourceRef:
                kind: HelmRepository
                name: minio
                namespace: forgejo
            interval: 1m
    values:
        secrets:
            existingSecret:
                name: minio-config
        tenant:
            name: forgejo
            configuration:
                name: minio-config
            pools:
                - servers: 4
                  name: pool-0
                  volumesPerServer: 1
                  size: 25Gi
                  labels:
                      minio.omnilium.local/tenant: forgejo
                  affinity:
                      podAntiAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                              - weight: 100
                                podAffinityTerm:
                                    labelSelector:
                                        matchLabels:
                                            minio.omnilium.local/tenant: forgejo
                                    topologyKey: topology.omnilium.local/host
                  resources: {}
                  topologySpreadConstraints:
                      - labelSelector:
                            matchLabels:
                                minio.omnilium.local/tenant: forgejo
                        topologyKey: topology.kubernetes.io/zone
                        maxSkew: 1
                        whenUnsatisfiable: ScheduleAnyway
            certificate:
                requestAutoCert: false
        ingress:
            console:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: local
                host: forgejo.minio.omnilium.local
                tls:
                    - secretName: minio-console-tls
                      hosts:
                          - forgejo.minio.omnilium.local
