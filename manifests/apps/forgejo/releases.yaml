apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: forgejo
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: forgejo
            version: '>=5.0.3 <5.1.0'
            sourceRef:
                kind: HelmRepository
                name: forgejo
                namespace: forgejo
            interval: 1m
    values:
        strategy:
            type: Recreate
        service:
            ssh:
                type: LoadBalancer
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: acme
            hosts:
                - host: git.omni.ms
                  paths:
                    - path: /
                      pathType: Prefix
            tls:
                - secretName: forgejo-tls
                  hosts:
                    - git.omni.ms
        resources:
            requests:
                cpu: 50m
                memory: 150Mi
            limits:
                cpu: 250m
                memory: 500Mi
        persistence:
            size: 25Gi
            storageClass: replicated
        signing:
            enabled: true
            existingSecret: forgejo-signing
        gitea:
            admin:
                username: webmaster
                password: ENC[AES256_GCM,data:U2E7azbvMVE8SoYCrIotZ5a7BoCA/2kTCT0NaVXod02rWr+HYPG/zugd6w==,iv:bHp+p5XaPYmn5L+WL3hsUxMXJ5RG+Svc/1+voZtKZ70=,tag:CQxsFi2lwgWDgUcCEBEdOQ==,type:str]
                email: webmaster@omnilium.com
            config:
                repository:
                    ACCESS_CONTROL_ALLOW_ORIGIN: git.omni.ms
                    DEFAULT_REPO_UNITS: repo.code,repo.releases,repo.pulls
                repository.pull-request:
                    DEFAULT_MERGE_STYLE: rebase-merge
                repository.upload:
                    FILE_MAX_SIZE: 10
                cors:
                    ENABLED: true
                    SCHEME: https
                    ALLOW_DOMAIN: git.omni.ms
                ui:
                    DEFAULT_SHOW_FULL_NAME: true
                ui.meta:
                    AUTHOR: Omnicloud Forgejo
                    KEYWORDS: git,forge,forgejo,omnicloud,omnilium
                server:
                    ENABLE_GZIP: true
                    LFS_START_SERVER: true
                indexer:
                    ISSUE_INDEXER_TYPE: elasticsearch
                    ISSUE_INDEXER_CONN_STR: ENC[AES256_GCM,data:MZxVL31htgk2oVsq+WTs+d/wM+0FeqB0l79voQjm4dwX0ERHBa20oJD+3fuBzzSjpbopTPHDBmO9lhHWFqOGhBxBf3jssEmB45Gdr8IAm73xCtm4pa4=,iv:Pb+sQUpSgPaeWbGm1/TAN5iwVcy6ZHRCfVPm7RD6dnk=,tag:y3O+Z+0kZcaqRQO5VGxOCg==,type:str]
                    REPO_INDEXER_ENABLED: true
                    REPO_INDEXER_TYPE: elasticsearch
                    REPO_INDEXER_CONN_STR: ENC[AES256_GCM,data:Y6vmsxkVDyed3hmyhh5YvYgCsD1xDOFv0YCax7BUL90QW0BYkM8bWjVvsuHVry54AIpFIJ6j2JSSAUQYar9SGP07y1OFBU5GsfHN28eAOiKPVJQ03RI=,iv:tQE8H3JcpiORT5hSp6kboksNmyAWrafC5Nk0lnmpsAI=,tag:CidwWaNXhODE+eq8sck2kA==,type:str]
                security:
                    REVERSE_PROXY_TRUSTED_PROXIES: 10.0.0.0/8
                    PASSWORD_HASH_ALGO: argon2
                    PASSWORD_COMPLEXITY: lower,upper,digit
                service:
                    DISABLE_REGISTRATION: true
                    DEFAULT_ENABLE_TIMETRACKING: false
                    DEFAULT_ORG_MEMBER_VISIBLE: true
                    VALID_SITE_URL_SCHEMES: https
                picture:
                    AVATAR_MAX_FILE_SIZE: 5242880
                    AVATAR_MAX_ORIGIN_SIZE: 524288
                    REPOSITORY_AVATAR_FALLBACK: image
                    AVATAR_STORAGE_TYPE: minio
                    REPOSITORY_AVATAR_STORAGE_TYPE: minio
                attachment:
                    MAX_SIZE: 10
                    STORAGE_TYPE: minio
                cron:
                    ENABLED: true
                time:
                    DEFAULT_UI_LOCATION: Europe/Bucharest
                packages:
                    STORAGE_TYPE: minio
                mirror:
                    MIN_INTERVAL: 30m
                    lfs:
                        STORAGE_TYPE: minio
                    repo-avatar:
                        STORAGE_TYPE: minio
                    repo-archive:
                        STORAGE_TYPE: minio
                    avatar:
                        STORAGE_TYPE: minio
                    storage.actions_log:
                        STORAGE_TYPE: minio
                    storage.artifacts:
                        STORAGE_TYPE: minio
                    storage.minio:
                        MINIO_ENDPOINT: minio.forgejo.svc.cluster.local:80
                        MINIO_ACCESS_KEY_ID: forgejo
                        MINIO_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:6/9AQUys6WO1Ib/fZOr2lVEYb7SiwhyTCzpvlgQ6z5M=,iv:1emoMwlcNxf/bPCUE9jJfz98LlADP8X2R1OB4AZ3TL4=,tag:Sk3y3vqQMIav0qG2V0XbRw==,type:str]
                        MINIO_BUCKET: forgejo
                        MINIO_LOCATION: hel1
                        MINIO_USE_SSL: false
        postgresql-ha:
            global:
                postgresql:
                    database: forgejo
                    password: ENC[AES256_GCM,data:1MnlDZkkGQII98srFmxW3c/T+8OXwmwefp4qrdEKqd5kpxhXXP9dpA7GKw==,iv:ym9Gdq6BrzGoXpIHPgkAFQD9qOE1PUcwlGeu20pPTEg=,tag:rzTSnHEdGEkKSklggDdfJw==,type:str]
                    username: forgejo
            postgresql:
                repmgrPassword: ENC[AES256_GCM,data:sBoG1YARAf/adr02iTofSNvi9uVkt1gkjoIFdXxPLuGA4o/sbVCMw2irfg==,iv:r9VPoe0XPNCPmcU57RWffaY0hNs/8LvJjY5/TZnI5XM=,tag:a0BcwLY+xwaUPmc8hcgIEg==,type:str]
                postgresPassword: ENC[AES256_GCM,data:KAwmPqiyNHLg3FrIKIEx+g9QPvFxXh+HFcQ6Dxm/wTZIKO4Kv06Iz3lLoA==,iv:ISNawgFNfTK2cv3Bd1baLcNxJJRgPyOUHSrht5e6TFM=,tag:DtoTHNVCbfuvMDWbWvwM8w==,type:str]
                password: ENC[AES256_GCM,data:6EHajlHCYEN6ySG546bLkl+PYTZyznr7qi7yMhkV6i5fqBKcUvCNvdnLSA==,iv:Rubuh6Fpn1UWq3A2hxBFRvVVNYxBn8YiIWR90L2xEh8=,tag:ZBM4mAvTbKNk42m7g38uCA==,type:str]
            pgpool:
                adminPassword: ENC[AES256_GCM,data:QS/eSgF6k1xr3GEcIN0Tzv5td2GsGDCVkVpv6qDcFOk+PJ+RQWAM/YKCTg==,iv:DgrVsyf6QvW5uw/dEP6sz0UdRF1OOPJiPAgqbKyK3CA=,tag:vCuqUp6QmBqbfIf02WxpFA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-06T22:38:49Z"
    mac: ENC[AES256_GCM,data:7mQKo9gf40UDiW+Oauo9FnRqkM1DfBBmkBs5LJUJ4SvWoyUVDsDXsr2a8gx2qD6doR1pAvgnUihzq7L56z3ZklScQEDMzFVWj4gE1SqVqToYtf6Wu+38H4W23OgTxG6Y/uBVvvEBFV6Z3bpBAkcr54in3ZermpDx/6h8YXNE+Vs=,iv:FqpTqK+44rIgtlGpn8i9p75OcBvXQHQkehsSb3ukIig=,tag:uOrUZxKK/Asi58wB3O81ug==,type:str]
    pgp:
        - created_at: "2024-04-06T22:38:49Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMENyhCW54lICnjip7f5oYvoiL9lLcrWk1Qmvb2Diue2hgp
            PMCO6WyeMPI7jCKiIDrXxTLCsAeKhF3ZIWw234vJVDWNAx8VRtFtW1oe3y+4EmW3
            DAR1nk102SWgZIS3z06hMGfiNTXl7jDn0fuQaO9VHVgKAErApiiZvrGvqB6lFQOc
            BlFBwHpcaSuLjpza4wjk09RmAQkCELh61UMY6ImS3JDYKXZ+ntRmg7ZbExKq71gd
            OLcJN8s4mG/+ZihjCSPSwgMJgLYE6h572hG1yR04jUGTq02CpljYNPV9zWrg4jkm
            P16Pivowg55FM98bi5chV1ZyVW2FXHlq
            =D5C4
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-06T22:38:49Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwMEHZkDIXKSKy7/Jnc7N79RLZls4S8FpPYHK3DZKh52e/Od
            dG1PB+8W2t0+DJEu3banFu8xARmmtx82uocNMt5sVfwognT2w008K8X1sFHky4P0
            pbtQxxqTlusNaXwjEstFMC1s/e2W+I9EjLl8pNDtexwP8mm5LOB4MC9wcVjtTt4/
            dGUJBRGvWNP9AuYSdnU7r9RmAQkCEHCxPCvIKE0ncBo8JkOFl22kaoTeQoxMDmlI
            AOwbKRzuEvv2zFEA6+PzUwofyqFFV5Y31SQUG68DGjpvJPemc+jtqYdfiSBbnxY3
            0PIXnpFLlnwD0ah0KDtX8r3fdIzeXbht
            =zLCz
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(password|repmgrPassword|postgresPassword|adminPassword|ISSUE_INDEXER_CONN_STR|REPO_INDEXER_CONN_STR|MINIO_SECRET_ACCESS_KEY)$
    version: 3.8.1
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: minio
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: tenant
            version: '>=5.0.14 <5.1.0'
            sourceRef:
                kind: HelmRepository
                name: minio
                namespace: forgejo
            interval: 1m
    values:
        secrets:
            existingSecret:
                name: minio-config
        tenant:
            name: forgejo
            configuration:
                name: minio-config
            pools:
                - servers: 4
                  name: pool-0
                  volumesPerServer: 1
                  size: 25Gi
                  labels:
                    minio.omnilium.local/tenant: forgejo
                  affinity:
                    podAntiAffinity:
                        preferredDuringSchedulingIgnoredDuringExecution:
                            - weight: 100
                              podAffinityTerm:
                                labelSelector:
                                    matchLabels:
                                        minio.omnilium.local/tenant: forgejo
                                topologyKey: topology.omnilium.local/host
                  resources: {}
                  topologySpreadConstraints:
                    - labelSelector:
                        matchLabels:
                            minio.omnilium.local/tenant: forgejo
                      topologyKey: topology.kubernetes.io/zone
                      maxSkew: 1
                      whenUnsatisfiable: ScheduleAnyway
            certificate:
                requestAutoCert: false
        ingress:
            console:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: local
                host: forgejo.minio.omnilium.local
                tls:
                    - secretName: minio-console-tls
                      hosts:
                        - forgejo.minio.omnilium.local
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-06T22:38:49Z"
    mac: ENC[AES256_GCM,data:7mQKo9gf40UDiW+Oauo9FnRqkM1DfBBmkBs5LJUJ4SvWoyUVDsDXsr2a8gx2qD6doR1pAvgnUihzq7L56z3ZklScQEDMzFVWj4gE1SqVqToYtf6Wu+38H4W23OgTxG6Y/uBVvvEBFV6Z3bpBAkcr54in3ZermpDx/6h8YXNE+Vs=,iv:FqpTqK+44rIgtlGpn8i9p75OcBvXQHQkehsSb3ukIig=,tag:uOrUZxKK/Asi58wB3O81ug==,type:str]
    pgp:
        - created_at: "2024-04-06T22:38:49Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMENyhCW54lICnjip7f5oYvoiL9lLcrWk1Qmvb2Diue2hgp
            PMCO6WyeMPI7jCKiIDrXxTLCsAeKhF3ZIWw234vJVDWNAx8VRtFtW1oe3y+4EmW3
            DAR1nk102SWgZIS3z06hMGfiNTXl7jDn0fuQaO9VHVgKAErApiiZvrGvqB6lFQOc
            BlFBwHpcaSuLjpza4wjk09RmAQkCELh61UMY6ImS3JDYKXZ+ntRmg7ZbExKq71gd
            OLcJN8s4mG/+ZihjCSPSwgMJgLYE6h572hG1yR04jUGTq02CpljYNPV9zWrg4jkm
            P16Pivowg55FM98bi5chV1ZyVW2FXHlq
            =D5C4
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-06T22:38:49Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwMEHZkDIXKSKy7/Jnc7N79RLZls4S8FpPYHK3DZKh52e/Od
            dG1PB+8W2t0+DJEu3banFu8xARmmtx82uocNMt5sVfwognT2w008K8X1sFHky4P0
            pbtQxxqTlusNaXwjEstFMC1s/e2W+I9EjLl8pNDtexwP8mm5LOB4MC9wcVjtTt4/
            dGUJBRGvWNP9AuYSdnU7r9RmAQkCEHCxPCvIKE0ncBo8JkOFl22kaoTeQoxMDmlI
            AOwbKRzuEvv2zFEA6+PzUwofyqFFV5Y31SQUG68DGjpvJPemc+jtqYdfiSBbnxY3
            0PIXnpFLlnwD0ah0KDtX8r3fdIzeXbht
            =zLCz
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(password|repmgrPassword|postgresPassword|adminPassword|ISSUE_INDEXER_CONN_STR|REPO_INDEXER_CONN_STR|MINIO_SECRET_ACCESS_KEY)$
    version: 3.8.1
