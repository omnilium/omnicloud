apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: forgejo
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: forgejo
            version: '>=5.0.3 <5.1.0'
            sourceRef:
                kind: HelmRepository
                name: forgejo
                namespace: forgejo
            interval: 1m
    values:
        service:
            ssh:
                type: LoadBalancer
        ingress:
            enabled: true
            annotations:
                cert-manager.io/cluster-issuer: acme
            hosts:
                - host: git.omni.ms
                  paths:
                    - path: /
                      pathType: Prefix
            tls:
                - secretName: forgejo-tls
                  hosts:
                    - git.omni.ms
        resources: {}
        persistence:
            size: 25Gi
            storageClass: replicated
            annotations:
                helm.sh/resource-policy: keep
        signing:
            enabled: true
            existingSecret: forgejo-signing
        gitea:
            admin:
                username: webmaster
                password: ENC[AES256_GCM,data:avdCzbhwEg9EzusReItYxl/imXXGfNnrGEGZtP/wKNipnPUffcyUZ0yuwA==,iv:/UemBfi0YR0mzUeB7Cj1SVylN4iIGT8MRbesNPPsDWM=,tag:0pnPH8YzxZacIQeMt0keSw==,type:str]
                email: webmaster@omnilium.com
            config:
                repository:
                    ACCESS_CONTROL_ALLOW_ORIGIN: git.omni.ms
                    DEFAULT_REPO_UNITS: repo.code,repo.releases,repo.pulls
                repository.pull-request:
                    DEFAULT_MERGE_STYLE: rebase-merge
                repository.upload:
                    FILE_MAX_SIZE: 10
                cors:
                    ENABLED: true
                    SCHEME: https
                    ALLOW_DOMAIN: git.omni.ms
                ui:
                    DEFAULT_SHOW_FULL_NAME: true
                ui.meta:
                    AUTHOR: Omnicloud Forgejo
                    KEYWORDS: git,forge,forgejo,omnicloud,omnilium
                server:
                    ENABLE_GZIP: true
                    LFS_START_SERVER: true
                indexer:
                    ISSUE_INDEXER_TYPE: elasticsearch
                    ISSUE_INDEXER_CONN_STR: ENC[AES256_GCM,data:jr7+iqkts0Us7HcinKB8ajL/dUQk7ImUKoPAzvqtLFyy/KmfclOq7Q/uIl+I/VISr17quQ+X8NSOiAjYNe96gUr8+LBNmok5+ctRCb9o9yRALkvJ9H8=,iv:M8P9sGdzVZA3PwXtPBcTj4Hy/DmOySLipRMnFTjiKSQ=,tag:McjV2p9IJkVJt1gMkX4nwA==,type:str]
                    REPO_INDEXER_ENABLED: true
                    REPO_INDEXER_TYPE: elasticsearch
                    REPO_INDEXER_CONN_STR: ENC[AES256_GCM,data:pc1CQZ5+5msU5LzwmTub8D9hV9Bb+th6fw4pM50n6s3+5uqXU4UVNBoj4wWZwceyWQde99uTbGzPpsh0liy4hY9V7LvFJUdCHYp1SgzL9lzQjnWYFA0=,iv:tlMbCAMsG3tpU7fjsxOGZC7rnWkXcf+LOkGnJHRtQqU=,tag:S+XjunQ1pxb1Do53ksyQIw==,type:str]
                security:
                    REVERSE_PROXY_TRUSTED_PROXIES: 10.0.0.0/8
                    PASSWORD_HASH_ALGO: argon2
                    PASSWORD_COMPLEXITY: lower,upper,digit,spec
                service:
                    DISABLE_REGISTRATION: true
                    DEFAULT_ENABLE_TIMETRACKING: false
                    DEFAULT_ORG_MEMBER_VISIBLE: true
                    VALID_SITE_URL_SCHEMES: https
                picture:
                    AVATAR_MAX_FILE_SIZE: 5242880
                    AVATAR_MAX_ORIGIN_SIZE: 524288
                    REPOSITORY_AVATAR_FALLBACK: image
                    STORAGE_TYPE: minio
                attachment:
                    MAX_SIZE: 10
                    STORAGE_TYPE: minio
                cron:
                    ENABLED: true
                time:
                    DEFAULT_UI_LOCATION: Europe/Bucharest
                packages:
                    STORAGE_TYPE: minio
                mirror:
                    MIN_INTERVAL: 30m
                lfs:
                    STORAGE_TYPE: minio
                repo-avatar:
                    STORAGE_TYPE: minio
                repo-archive:
                    STORAGE_TYPE: minio
                avatar:
                    STORAGE_TYPE: minio
                storage.actions_log:
                    STORAGE_TYPE: minio
                storage.artifacts:
                    STORAGE_TYPE: minio
                storage:
                    SERVE_DIRECT: false
                    MINIO_ENDPOINT: minio.forgejo.svc.cluster.local:80
                    MINIO_ACCESS_KEY_ID: forgejo
                    MINIO_SECRET_ACCESS_KEY: ENC[AES256_GCM,data:j0N5VqjZ/upmTnYqGNBVWYZUuGPoChSUUzdn95nDG3o=,iv:74nQ9X4zNXEowdYuYBAqN1eQt97H0zeIqefuCPiaNMQ=,tag:6/PBxjtm3r8dVTsvwaWjKA==,type:str]
                    MINIO_BUCKET: forgejo
                    MINIO_LOCATION: hel1
                    MINIO_USE_SSL: false
        postgresql-ha:
            global:
                postgresql:
                    database: forgejo
                    password: ENC[AES256_GCM,data:bdtTRWjPchH53AZ+khU/NXPzWLi1ke1dHbPL8XwAHqroduzqCzKIZEXj9A==,iv:EnwimO3vC2GniHiPUzsM2RTVJrJhkr9jjNi6nO+MHEw=,tag:7s7XoLba7L77lGqT8+JTRg==,type:str]
                    username: forgejo
            postgresql:
                repmgrPassword: ENC[AES256_GCM,data:ABHWgfLhpffYhAMQOsROABCBywuFiTlhn1jq3ADb5BT3NZOE5yNdwy/BRw==,iv:mVIxaADy8LJBVbREFeD4D+I6vp/l9Y3zjNZBnrmyiHI=,tag:K8syfBqDHHkPVlC17FfLew==,type:str]
                postgresPassword: ENC[AES256_GCM,data:K7yjqdSFd8AinWVAQ7OXVnK2IjLhedV6LJeUp435vACzjHKvVJYBq4NGZg==,iv:Qoz/1VdG6fs7lbgxdJTAshvKU8IFJr1D7iYF0OuF744=,tag:3lW6mfBSVzAIbvei3l/qVw==,type:str]
                password: ENC[AES256_GCM,data:s9VwykRazJ1c72Iede0DWDE8jp438vK1bXyuizUGuOBli31BFAB6HGXeBQ==,iv:TOt1mhjW9M6+WfvqM10ovw6Mq/bQSrLk2lmg47XRWaM=,tag:FmR2DMCG06RRqjmXuoRAtQ==,type:str]
            pgpool:
                adminPassword: ENC[AES256_GCM,data:nLVFf5DNNMqlLg+EPj8BZjgc6kJdL1xHzdkTPK5jAP1C5hlgwuDi7RMJWQ==,iv:tba98kOt4hSCNf1OVwMeuUbCwDQuBD8stxtevvexnCU=,tag:oLCzapgvVqZkl8W3O/0NdA==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-06T21:13:59Z"
    mac: ENC[AES256_GCM,data:TvvOjLM025BqASmcT/G6YL4/M+TixIWkPMjANQ+Ypo5ZbhHkmaJNxGT3JNSuz8PTM8kMT2H2XvIH9KeInl2I07iprp/b/u/+IPDfRkEf71JadBMsAtVynDippwXLQReC7yjobbSg8b0sJnJW5n55ijWyyRJkAAgJANUKus014DU=,iv:x9spX/K6KP15o/tt9HEsQ/tT47mpQsLxSGwwH5azTTU=,tag:zKNG8YbMtt3eHwWK8SXeBQ==,type:str]
    pgp:
        - created_at: "2024-04-06T21:13:59Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMEK31GFdEm5sMpyNI4GA2F6Zzj+H1dNRESUVZC6+TJ1zAS
            oI1J49ATOXJ3YlLIWF3nNyrHWtYlhmi3IbhnaslOGuuXoWAQZvyi/j7zvKJoiwlx
            IJZFCSwLEVfvHrdPKgsJMEvf4qr/TGdRNdmBtMy/8TO+Bghtt+g59oYkMvygnVEi
            i1BRq2kxpjIs4q24dnALPdRoAQkCEO+1q2Cc2Ox8/rHshiSDrpj40b2lj2fCgaxm
            RDc0ztKu5uy89y8AN/teX6LVrZtUhYT7IhWNyenTa97VxfOSGdhUVTSeDIPUTJ8V
            Rt/kJkMqF2ljU6vqXojaP/AQ5goB5ZaGtls=
            =eBld
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-06T21:13:59Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwME9j9dCd4I02FrsD7FI3oghIJDjiXz4Ew6DkCiqwp1VHRZ
            BlqlIfAUxeNVMYiZBeBnPPvaGrd8XXhOAAqfucVCT16kNDm0lhrwKw9Fy3va07Yb
            HmtrQf596hZhmQOdunz3MCb2ZgdTdSQo2gpXYe6CwXzk1QvFXoyE8jAVPJ5y9ims
            2RU3K1sj8B46t3jqyUAkk9RoAQkCENauCV7hx16E3AieW3HzggsWxAqNfPnDu8Ow
            qBgDwxsNKQO4hI1q/W0DKWhXRbHJiwEMc2yaCraSWgfAJonWQg/MMFWJiGpcJcaP
            xz1+ALZHJJQS2rJ3eNb2QDKx8O5SUbFm8Q0=
            =Ptar
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(password|repmgrPassword|postgresPassword|adminPassword|ISSUE_INDEXER_CONN_STR|REPO_INDEXER_CONN_STR|MINIO_SECRET_ACCESS_KEY)$
    version: 3.8.1
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: minio
    namespace: forgejo
spec:
    interval: 10m0s
    chart:
        spec:
            chart: tenant
            version: '>=5.0.14 <5.1.0'
            sourceRef:
                kind: HelmRepository
                name: minio
                namespace: forgejo
            interval: 1m
    values:
        secrets:
            existingSecret:
                name: minio-config
        tenant:
            name: forgejo
            configuration:
                name: minio-config
            pools:
                - servers: 4
                  name: pool-0
                  volumesPerServer: 1
                  size: 25Gi
                  labels:
                    minio.omnilium.local/tenant: forgejo
                  affinity:
                    podAntiAffinity:
                        preferredDuringSchedulingIgnoredDuringExecution:
                            - weight: 100
                              podAffinityTerm:
                                labelSelector:
                                    matchLabels:
                                        minio.omnilium.local/tenant: forgejo
                                topologyKey: topology.omnilium.local/host
                  resources: {}
                  topologySpreadConstraints:
                    - labelSelector:
                        matchLabels:
                            minio.omnilium.local/tenant: forgejo
                      topologyKey: topology.kubernetes.io/zone
                      maxSkew: 1
                      whenUnsatisfiable: ScheduleAnyway
            certificate:
                requestAutoCert: false
        ingress:
            console:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: local
                host: forgejo.minio.omnilium.local
                tls:
                    - secretName: minio-console-tls
                      hosts:
                        - forgejo.minio.omnilium.local
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-06T21:13:59Z"
    mac: ENC[AES256_GCM,data:TvvOjLM025BqASmcT/G6YL4/M+TixIWkPMjANQ+Ypo5ZbhHkmaJNxGT3JNSuz8PTM8kMT2H2XvIH9KeInl2I07iprp/b/u/+IPDfRkEf71JadBMsAtVynDippwXLQReC7yjobbSg8b0sJnJW5n55ijWyyRJkAAgJANUKus014DU=,iv:x9spX/K6KP15o/tt9HEsQ/tT47mpQsLxSGwwH5azTTU=,tag:zKNG8YbMtt3eHwWK8SXeBQ==,type:str]
    pgp:
        - created_at: "2024-04-06T21:13:59Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMEK31GFdEm5sMpyNI4GA2F6Zzj+H1dNRESUVZC6+TJ1zAS
            oI1J49ATOXJ3YlLIWF3nNyrHWtYlhmi3IbhnaslOGuuXoWAQZvyi/j7zvKJoiwlx
            IJZFCSwLEVfvHrdPKgsJMEvf4qr/TGdRNdmBtMy/8TO+Bghtt+g59oYkMvygnVEi
            i1BRq2kxpjIs4q24dnALPdRoAQkCEO+1q2Cc2Ox8/rHshiSDrpj40b2lj2fCgaxm
            RDc0ztKu5uy89y8AN/teX6LVrZtUhYT7IhWNyenTa97VxfOSGdhUVTSeDIPUTJ8V
            Rt/kJkMqF2ljU6vqXojaP/AQ5goB5ZaGtls=
            =eBld
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-06T21:13:59Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwME9j9dCd4I02FrsD7FI3oghIJDjiXz4Ew6DkCiqwp1VHRZ
            BlqlIfAUxeNVMYiZBeBnPPvaGrd8XXhOAAqfucVCT16kNDm0lhrwKw9Fy3va07Yb
            HmtrQf596hZhmQOdunz3MCb2ZgdTdSQo2gpXYe6CwXzk1QvFXoyE8jAVPJ5y9ims
            2RU3K1sj8B46t3jqyUAkk9RoAQkCENauCV7hx16E3AieW3HzggsWxAqNfPnDu8Ow
            qBgDwxsNKQO4hI1q/W0DKWhXRbHJiwEMc2yaCraSWgfAJonWQg/MMFWJiGpcJcaP
            xz1+ALZHJJQS2rJ3eNb2QDKx8O5SUbFm8Q0=
            =Ptar
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(password|repmgrPassword|postgresPassword|adminPassword|ISSUE_INDEXER_CONN_STR|REPO_INDEXER_CONN_STR|MINIO_SECRET_ACCESS_KEY)$
    version: 3.8.1
