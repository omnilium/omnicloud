---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: kube-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/kube-system
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: piraeus-system
  namespace: flux-system
spec:
  interval: 10m0s
  url: https://github.com/piraeusdatastore/piraeus-operator
  ref:
    tag: v2.5.0
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: piraeus-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./config/default
  prune: true
  sourceRef:
    kind: GitRepository
    name: piraeus-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: piraeus-system-config
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/piraeus-system-config
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  healthChecks:
    - apiVersion: kustomize.toolkit.fluxcd.io/v2beta1
      kind: Kustomization
      name: piraeus-system
      namespace: flux-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: metallb-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/metallb-system
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: metallb-system-config
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/metallb-system-config
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2beta1
      kind: HelmRelease
      name: metallb
      namespace: metallb-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: tls-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/tls-system
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: tls-system-config
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./manifests/infrastructure/tls-system-config
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  healthChecks:
    - apiVersion: helm.toolkit.fluxcd.io/v2beta1
      kind: HelmRelease
      name: cert-manager
      namespace: tls-system
    - apiVersion: helm.toolkit.fluxcd.io/v2beta1
      kind: HelmRelease
      name: trust-manager
      namespace: tls-system
  decryption:
    provider: sops
    secretRef:
      name: sops-gpg
# ---
# apiVersion: kustomize.toolkit.fluxcd.io/v1
# kind: Kustomization
# metadata:
#   name: traefik-system
#   namespace: flux-system
# spec:
#   interval: 10m0s
#   path: ./manifests/infrastructure/traefik-system
#   prune: true
#   sourceRef:
#     kind: GitRepository
#     name: flux-system
#   healthChecks:
#     - apiVersion: helm.toolkit.fluxcd.io/v2beta1
#       kind: HelmRelease
#       name: metallb
#       namespace: metallb-system
#     - apiVersion: helm.toolkit.fluxcd.io/v2beta1
#       kind: HelmRelease
#       name: cert-manager
#       namespace: tls-system
#     - apiVersion: helm.toolkit.fluxcd.io/v2beta1
#       kind: HelmRelease
#       name: trust-manager
#       namespace: tls-system
# ---
# apiVersion: kustomize.toolkit.fluxcd.io/v1
# kind: Kustomization
# metadata:
#   name: traefik-system-config
#   namespace: flux-system
# spec:
#   interval: 10m0s
#   path: ./manifests/infrastructure/traefik-system-config
#   prune: true
#   sourceRef:
#     kind: GitRepository
#     name: flux-system
#   healthChecks:
#     - apiVersion: helm.toolkit.fluxcd.io/v2beta1
#       kind: HelmRelease
#       name: traefik
#       namespace: traefik-system
