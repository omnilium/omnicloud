apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
    name: thanos
    namespace: flux-system
spec:
    interval: 10m0s
    timeout: 5m0s
    chart:
        spec:
            chart: thanos
            version: 1.16.*
            sourceRef:
                kind: HelmRepository
                name: stevehipwell
            interval: 60m0s
    releaseName: thanos
    targetNamespace: monitoring
    install:
        remediation:
            retries: 3
        createNamespace: true
    upgrade:
        remediation:
            retries: 3
    values:
        nameOverride: thanos
        fullnameOverride: thanos
        objstoreConfig:
            name: ENC[AES256_GCM,data:DG0b7jn7HGGMsqBkbLEkI/0Np24Qz87D9rtrqg==,iv:27aI8rVw9bg5pi3K8JI3YEGbUX+xUO4IsEP27QMcRXM=,tag:ei9npaduIE6qTAlU/jGAjQ==,type:str]
            value: ENC[AES256_GCM,data:PrxOhsxuNfQA8JbFoH35rN9Pg1+y1TGEmdb72rLnkVwasGh8yMcov3f4FGacuQ4xEb0csLqqfG7YT3ayYAVRFn/xBI/p85gnjgDxHSfd/9Z76+poX7YI2iH37LY+QkKdUPCjuYYZbEPJxhFXmWjb0j0+1PQiIrjHzd7A/pKOzC22V46vkIZq3VslEcWvZRQlVXxGA4s79wub6wsapXkjCIujUHHL07fTp5CRxIGEb5xT1AnkgjrjHPi8K7peU1yP8ftcKfKq5EMBHj2FyJ3CEnkDNXnBS5+sh3Slq+jKdDgS9ND0l4bhoTGSeKfqRuqRsXRCkTck+ak=,iv:P43+9FQ0cl/+70wJPOTOfyNsrHU3miIQ2r/YXU8iedY=,tag:+EntS7Cp7RlcP0DiGunZqA==,type:str]
        serviceMonitor:
            enabled: true
        compact:
            enabled: true
            resources: {}
        query:
            ingress:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: omnicloud
                hosts:
                    - thanos.omnilium.local
                tls:
                    - secretName: thanos-tls
                      hosts:
                        - thanos.omnilium.local
            replicas: 2
            resources: {}
            # autoscaling:
            #   enabled: true
            #   minReplicas: 1
            #   maxReplicas: 3
            #   targetMemoryUtilizationPercentage: 75
            # podDistruptionBudget:
            #   enabled: true
            #   minAvailable: 1
            extraArgs:
                - --store=dnssrv+_grpc._tcp.thanos-store-gateway-headless.monitoring.svc.cluster.local
                - --store=dnssrv+_grpc._tcp.promstack-thanos-discovery.monitoring.svc.cluster.local
            podLabels:
                app.omnilium.cloud/identifier: thanos
            topologySpreadConstraints:
                - maxSkew: 1
                  topologyKey: topology.omnilium.cloud/host
                  whenUnsatisfiable: ScheduleAnyway
                  labelSelector:
                    matchLabels:
                        app.omnilium.cloud/identifier: thanos
        queryFrontend:
            enabled: true
            ingress:
                enabled: true
                annotations:
                    cert-manager.io/cluster-issuer: omnicloud
                hosts:
                    - frontend.thanos.omnilium.local
                tls:
                    - secretName: thanos-frontend-tls
                      hosts:
                        - frontend.thanos.omnilium.local
            replicas: 2
            resources: {}
            # autoscaling:
            #   enabled: true
            #   minReplicas: 1
            #   maxReplicas: 3
            #   targetMemoryUtilizationPercentage: 75
            # podDistruptionBudget:
            #   enabled: true
            #   minAvailable: 1
            podLabels:
                app.omnilium.cloud/identifier: thanos-frontend
            topologySpreadConstraints:
                - maxSkew: 1
                  topologyKey: topology.omnilium.cloud/host
                  whenUnsatisfiable: ScheduleAnyway
                  labelSelector:
                    matchLabels:
                        app.omnilium.cloud/identifier: thanos-frontend
        storeGateway:
            replicas: 2
            resources: {}
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age: []
    lastmodified: "2024-04-16T20:47:33Z"
    mac: ENC[AES256_GCM,data:YHasICwjXc4Czi2beiW5ERRkj0P1p//WXGAINh3eQOIIOTn825K3d1L+ZZkZQDJrMel3bKiemRP5JZBKf8YrqQeHoebXvNWlx06THZYbQuPdMOO8a4DEkWCQCAEkm0H/1N6bc+gKS9Vvf/QBqf3oqIG1iBVHBwfAR6I832kSly0=,iv:0KPWyGryEK/JcfgfvvZMx+qleWt55Z9ugaQQtDwlo5Y=,tag:guDHIVorQ22MCmGdEH4dhA==,type:str]
    pgp:
        - created_at: "2024-04-16T20:47:33Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4D0dRkdsWQFPUSAwMEDpGkkOO1nNa3+uSiiDZWOJl+ZxyYByWA6nsPSeodsksF
            XNHO6v4epngNgJ3kOgmPlHnf6ukM57aqekmEkBGDX2nhkPMjDgPA7D/RubY2eQmP
            I6Oa2R024Z0oEZLvbhHaMJgo31mYHz8r++Wz3jtNuX8PN7PZWaa6sv6Mk1agl6VX
            Zre06Q1xqkafRIaTZaIv6dRbAQkCEAwbuKhQRZyRxFPP5v9EQcJ/BRg9prWWE4yh
            K2rP47tpcG8QPoLt0gzkAeLCKsGqiZsuKlCYikzDq5dka6BI1ScID6EXyKBQtQcP
            kKc1JLejRqUU4IisKA==
            =6OMe
            -----END PGP MESSAGE-----
          fp: 0F003E832B1DA1A11CA9F206712F90FA248BBBC2
        - created_at: "2024-04-16T20:47:33Z"
          enc: |-
            -----BEGIN PGP MESSAGE-----

            hJ4DLG005yzvDc8SAwMEJzPY/g0Zh7sM4B5cDehcnlFNVCy6VhQHrdea1HiUjHkW
            foVZNGBZO9WDKukMiBtoCzGah07lBkcpGeI6kf94U2EgjtjK8T/p0y2RMjkoYqrY
            34w+rkNzQc3s1XCOBve9MBcwBFEBWMAU7ZYfTNizb9QwRCt3oCAYIskLBHFt3FZv
            MTjhdJyXBDIPzryK/ofxRNRbAQkCED3ilvvyWRCtyfu7i22BoTC2hCcNfUTLf3F8
            veyCc7o4jXqSqd86BV28hHOveLmsEr3GQMF/nAq1TOD4oaFsl2RkCZL0D5FmVJzr
            rbCIwSkTV25YN9o5KQ==
            =WkCR
            -----END PGP MESSAGE-----
          fp: 1918B94484C52CDE42CA1B87E7812096B8DA4A52
    encrypted_regex: ^(data|adminPassword|secret_key|secretKey|objstoreConfig|secretAccessKey)$
    version: 3.8.1
